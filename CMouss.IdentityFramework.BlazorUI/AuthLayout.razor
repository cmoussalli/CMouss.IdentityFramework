@using CMouss.IdentityFramework
@using CMouss.IdentityFramework.BlazorUI

@inject CookieAuthService CookieAuth
@inject NavigationManager NavManager

@if (authLayoutModel is not null)
{
    if (authLayoutModel.User is not null)
    {
        <CascadingValue Value="authLayoutModel">
            @ChildContent
        </CascadingValue>

    }
}

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }

    public AuthLayoutModel authLayoutModel { get; set; }


    // protected override void OnInitialized()
    // {
    //     GetUserInfo();

    // }

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // This will ensure that the user info is fetched only once when the component is first rendered.
            GetUserInfo();
        }
        return base.OnAfterRenderAsync(firstRender);
    }


    public async Task GetUserInfo()
    {
        try
        {
            var token = await CookieAuth.GetTokenAsync();
            authLayoutModel = new();
            if (!string.IsNullOrEmpty(token) && token.Length > 10)
            {
                UserToken userToken = IDFManager.userTokenService.Validate(token, TokenValidationMode.UseDefault);
                if (userToken == null)
                {
                    await RedirectToLogin();
                }
                else
                {
                    authLayoutModel.IsAuthenticated = true;
                    authLayoutModel.User = userToken.User;
                    authLayoutModel.Token = userToken.Token;

                }
            }
            else
            {
                await RedirectToLogin();
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await RedirectToLogin();
        }

    }

    public async Task RedirectToLogin()
    {
        authLayoutModel = new();
        authLayoutModel.IsAuthenticated = false;
        authLayoutModel.Token = "";
        authLayoutModel.User = null;
        await CookieAuth.DeleteTokenAsync();
        StateHasChanged();
        NavManager.NavigateTo($"{IDFBlazorUIConfig.LoginRedirectURL}?returnurl={NavManager.ToAbsoluteUri(NavManager.Uri).PathAndQuery}", true);
    }



}
