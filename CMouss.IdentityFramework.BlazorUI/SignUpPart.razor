@rendermode InteractiveServer

@using CMouss.IdentityFramework;
@using Microsoft.AspNetCore.Components.Sections

@inject NavigationManager NavManager



<form class="form-horizontal" @onsubmit:preventDefault>

    <div class="mb-3">
        <label for="useremail" class="form-label">Email</label>
        <InputText @bind-Value="email" class="form-control" />
        <div class="invalid-feedback">
            Please Enter Email
        </div>
    </div>

    <div class="mb-3">
        <label for="fullName" class="form-label">Full Name</label>
        <InputText @bind-Value="fullName" class="form-control" />
        <div class="invalid-feedback">
            Please Enter FullName
        </div>
    </div>

    <div class="mb-3">
        <label for="username" class="form-label">User Name</label>
        <InputText @bind-Value="userName" class="form-control" />
        <div class="invalid-feedback">
            Please Enter Username
        </div>
    </div>

    <div class="mb-3">
        <label for="userpassword" class="form-label">Password</label>
        <InputText @bind-Value="password" type="password" class="form-control" placeholder="Password" />
        <div class="invalid-feedback">
            Please Enter Password
        </div>
    </div>

    <div class="mt-4 d-grid">
        <button type="button" class="btn btn-primary waves-effect waves-light" @onclick="CreateUser">@IDFBlazorUIConfig.FormLabels.SignupButton</button>
    </div>

    @if (errors.Count > 0)
    {
        <div class="alert alert-danger mt-3">
            <ul>
                @foreach (var error in errors)
                {
                    <li>@error</li>
                }
            </ul>
        </div>
    }

    
</form>








@code {


    [CascadingParameter] public AuthLayoutModel authLayoutModel { get; set; } = new();


    bool success;
    string systemMessage;
    List<string> errors = new();

    public bool IsLoading_Signup { get; set; }

    string userName;
    string fullName;
    string email;
    string password;

    public bool HasMetaMask { get; set; }
    public bool IsSiteConnected { get; set; }
    public string ConnectedWallet { get; set; }



    private async Task CreateUser()
    {
        errors = new();
        IsLoading_Signup = true;
        StateHasChanged();

        // Validate required fields
        if (string.IsNullOrWhiteSpace(email))
        {
            errors.Add("Email is required");
        }
        else if (!IsValidEmail(email))
        {
            errors.Add("Please enter a valid email address");
        }

        if (string.IsNullOrWhiteSpace(fullName))
        {
            errors.Add("Full name is required");
        }

        if (string.IsNullOrWhiteSpace(userName))
        {
            errors.Add("Username is required");
        }

        if (string.IsNullOrWhiteSpace(password))
        {
            errors.Add("Password is required");
        }
        else if (password.Length < 6)
        {
            errors.Add("Password must be at least 6 characters long");
        }

        if (errors.Count > 0)
        {
            IsLoading_Signup = false;
            StateHasChanged();
            return;
        }

        try
        {
            string res = IDFManager.userService.Create(userName, password, fullName, email, false, false);
            CMouss.IdentityFramework.User usr = IDFManager.userService.Details(res);
            systemMessage = "Your account is ready, please login";
            NavManager.NavigateTo(IDFBlazorUIConfig.SignupRedirectURL, true);
        }
        catch (Exception ex)
        {
            errors.Add(ex.Message);
            systemMessage = ex.Message;
            IsLoading_Signup = false;
            StateHasChanged();
        }
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }





}